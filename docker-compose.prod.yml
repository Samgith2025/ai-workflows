# =============================================================================
# GPTMarket Generator - Production Docker Compose (Dokploy)
# =============================================================================
#
# DOKPLOY SETUP:
# 1. Create a new "Compose" application in Dokploy
# 2. Point to this file: docker-compose.prod.yml
# 3. Add environment variables in Dokploy UI (see docs/DEPLOYMENT.md)
# 4. Deploy!
#
# Access Temporal UI via SSH tunnel:
#   ssh -L 8080:localhost:8080 user@your-server
#   Then open http://localhost:8080 in your browser
#
# =============================================================================

services:
  # ============================================================================
  # Temporal Server
  # ============================================================================
  temporal:
    image: temporalio/auto-setup:1.24
    ports:
      - "${TEMPORAL_PORT:-7233}:7233"
    environment:
      # Database (postgres12 is the driver name for Temporal auto-setup)
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-temporal}
      - POSTGRES_PWD=${POSTGRES_PASSWORD:-temporal}
      - POSTGRES_SEEDS=temporal-postgres
    depends_on:
      temporal-postgres:
        condition: service_healthy
    networks:
      - gptmarket-network
    # Healthcheck disabled - Temporal takes time to initialize and the CLI healthcheck is unreliable
    # The dependent services will retry connecting if needed
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 512M

  # ============================================================================
  # Temporal Web UI - Localhost only (SSH tunnel access)
  # ============================================================================
  temporal-ui:
    image: temporalio/ui:2.31.2
    ports:
      - "127.0.0.1:8080:8080"  # Localhost only - access via SSH tunnel
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:8080
    depends_on:
      - temporal
    networks:
      - gptmarket-network
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================================================
  # PostgreSQL for Temporal persistence
  # ============================================================================
  temporal-postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-temporal}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-temporal}
      POSTGRES_DB: temporal
    volumes:
      - temporal-postgres-data:/var/lib/postgresql/data
    networks:
      - gptmarket-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-temporal}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ============================================================================
  # Temporal Worker - Main generation worker
  # ============================================================================
  worker:
    image: ${WORKER_IMAGE:-ghcr.io/gptmarket/visual-generator:latest}
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m app.temporal.worker
    env_file: .env  # Auto-generated by Dokploy from UI environment variables
    environment:
      # Docker-specific overrides
      TEMPORAL_HOST: temporal:7233
      ENVIRONMENT: production
    networks:
      - gptmarket-network
    depends_on:
      - temporal
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    deploy:
      replicas: ${WORKER_REPLICAS:-2}
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

# =============================================================================
# Volumes
# =============================================================================
volumes:
  temporal-postgres-data:
    name: gptmarket-temporal-postgres

# =============================================================================
# Networks
# =============================================================================
networks:
  gptmarket-network:
    name: gptmarket-network
    driver: bridge
    # External apps (like Next.js) can join this network to connect to Temporal
    # In Dokploy, add this to your Next.js compose:
    #   networks:
    #     gptmarket-network:
    #       external: true
    # Then connect to: temporal:7233
